// Generated by CoffeeScript 1.10.0
/*! Gitspace 0.0.3 //// MIT Licence //// http://gitspace.richplastow.com/ */
(function(global) {

/* Define the Oopish container. 
Rather than just a generic object, the Oopish container can also be used as 
a handy shortcut for console.log(). Note bind() (http://goo.gl/66ffgl), and 
unusual IE8-9 behaviour (http://goo.gl/ZmG9Xs). */
var oo = (function (c) { return (
(!c || !c.log) // IE8-9 without F12 dev-tools, IE6-7, FF1-3.6
? function () {}
: ("object" === typeof c.log) // IE8-9 with F12 dev-tools
? function () { c.log([].slice.call(arguments).join(" ")) }
: (! Function.prototype.bind) // OP10.6-11.5, SF4-5.0, iOS3-5.1, ADRD2.1-3.0?
? function () { c.log.apply(c, arguments) }
: c.log.bind(c)
)}(console));

/* Define constants generated by oopish-build and injected into app-scope. */
oo.G = global // global scope, passed into the closure as an argument
oo.T = "Gitspace" // project title, from package.json
oo.V = "0.0.3" // project version, from package.json


/*! Gitspace 0.0.3 */
var DB, GitSpace, getDefaultPage, sendFavicon, sendPage,
  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

oo.A = 'array';

oo.B = 'boolean';

oo.D = 'document';

oo.E = 'error';

oo.F = 'function';

oo.I = 'integer';

oo.N = 'number';

oo.O = 'object';

oo.R = 'regexp';

oo.S = 'string';

oo.U = 'undefined';

oo.X = 'null';

oo._ = (Math.random().toString(36) + '00000000').substr(2, 8);

oo.ROBUSTABLE = (function() {
  var error1;
  if (!Object.preventExtensions) {
    return false;
  } else if (Object.defineProperty) {
    try {
      Object.defineProperty({}, 'x', {});
      return true;
    } catch (error1) {
      return false;
    }
  } else {
    return true;
  }
})();

oo.is = function(c, t, f) {
  if (t == null) {
    t = true;
  }
  if (f == null) {
    f = false;
  }
  if (c) {
    return t;
  } else {
    return f;
  }
};

oo.isU = function(x) {
  return oo.U === typeof x;
};

oo.isX = function(x) {
  return null === x;
};

oo.type = function(a) {
  var ta;
  if (oo.isX(a)) {
    return oo.X;
  }
  ta = typeof a;
  if ({
    undefined: 1,
    string: 1,
    number: 1,
    boolean: 1
  }[ta]) {
    return ta;
  }
  if (!a.nodeName && a.constructor !== Array && /function/i.test('' + a)) {
    return oo.F;
  }
  return {}.toString.call(a).match(/\s([a-z0-9]+)/i)[1].toLowerCase();
};

oo.ex = function(x, a, b) {
  var pos;
  if (-1 === (pos = a.indexOf(x))) {
    return x;
  } else {
    return b.charAt(pos);
  }
};

oo.has = function(h, n, t, f) {
  if (t == null) {
    t = true;
  }
  if (f == null) {
    f = false;
  }
  if (-1 !== h.indexOf(n)) {
    return t;
  } else {
    return f;
  }
};

oo.uid = function(p) {
  if (p == null) {
    p = 'id';
  }
  return p + '_' + (Math.random().toString(36) + '00000000').substr(2, 8);
};

oo.uid62 = function(p, l) {
  var c;
  if (p == null) {
    p = 'id';
  }
  if (l == null) {
    l = 8;
  }
  c = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
  return p + '_' + ((function() {
    var results;
    results = [];
    while (l--) {
      results.push(c.charAt(Math.floor(Math.random() * 62)));
    }
    return results;
  })()).join('');
};

oo.pad = oo.lpad = function(s, l, c) {
  if (c == null) {
    c = ' ';
  }
  return s + Array(l - s.length + 1).join(c);
};

oo.rpad = function(s, l, c) {
  if (c == null) {
    c = ' ';
  }
  return Array(l - s.length + 1).join(c) + s;
};

oo.insert = function(basis, overlay, offset) {
  return basis.slice(0, offset) + overlay + basis.slice(offset + overlay.length);
};

if (oo.ROBUSTABLE) {
  oo.define = function(obj, name, value, kind) {
    switch (kind) {
      case 'constant':
        return Object.defineProperty(obj, name, {
          value: value,
          enumerable: true
        });
      case 'private':
        return Object.defineProperty(obj, name, {
          value: value,
          enumerable: false
        });
    }
  };
} else {
  oo.define = function(obj, name, value, kind) {
    return obj[name] = value;
  };
}

if (oo.ROBUSTABLE) {
  oo.lock = function(obj) {
    var j, key, len, ref;
    ref = Object.keys(obj);
    for (j = 0, len = ref.length; j < len; j++) {
      key = ref[j];
      Object.defineProperty(obj, key, {
        writable: false,
        configurable: false
      });
    }
    Object.preventExtensions(obj);
    if (obj.prototype && obj !== obj.prototype) {
      return oo.lock(obj.prototype);
    }
  };
} else {
  oo.lock = function() {};
}

oo.vArray = function(M, arr, signature, fallback) {
  var i, j, len, len1, limit, m, matches, max, min, pass, ref, ref1, ref2, rule, tv, type, types, value;
  matches = signature.match(/^<\[([|a-z]+)\s*(.*)\](\d+-\d+)?>$/i);
  if (!matches) {
    throw RangeError("/gitspace/oopish/oo-helpers.litcoffee oo.vArray()\n  signature " + signature + " is invalid");
  }
  signature = matches[0], types = matches[1], rule = matches[2], limit = matches[3];
  if (!arr) {
    return fallback;
  }
  if (oo.A !== oo.type(arr)) {
    throw RangeError(M + (" is type " + (oo.type(arr)) + " not array"));
  }
  if (limit) {
    ref = limit.split('-'), min = ref[0], max = ref[1];
    if (arr.length < min || arr.length > max) {
      throw RangeError(M + (".length is " + arr.length + " (must be " + limit + ")"));
    }
  }
  if ('any' === types) {
    return arr;
  }
  for (i = j = 0, len = arr.length; j < len; i = ++j) {
    value = arr[i];
    tv = oo.type(value);
    pass = false;
    ref1 = types.split('|');
    for (m = 0, len1 = ref1.length; m < len1; m++) {
      type = ref1[m];
      if ((oo.N === type || oo.I === type) && oo.N === tv) {
        if (oo.I === type && value % 1) {
          throw RangeError(M + ("[" + i + "] is a number but not an integer"));
        }
        if (rule) {
          ref2 = rule.split('-'), min = ref2[0], max = ref2[1];
          if (value < min || value > max) {
            throw RangeError(M + ("[" + i + "] is " + value + " (must be " + rule + ")"));
          }
        }
        pass = true;
        break;
      }
      if (type === tv) {
        if (oo.S === tv && rule) {
          if (!RegExp(rule).test(value)) {
            throw RangeError(M + ("[" + i + "] fails " + rule));
          }
        }
        pass = true;
        break;
      }
      if (/^[A-Z]/.test(type)) {
        if (oo.O === tv) {
          if (eval("value instanceof " + type)) {
            pass = true;
            break;
          }
        }
      }
    }
    if (pass) {
      continue;
    }
    throw TypeError(M + ("[" + i + "] is type " + tv + " not " + types));
  }
  return arr;
};

oo.vArg = function(M, value, signature, fallback) {
  var j, key, len, matches, max, min, pfx, ref, ref1, rule, tv, type, types;
  matches = signature.match(/^([_a-z][_a-z0-9]*)\s+<([|a-z]+)\s*(.*)>$/i);
  if (!matches) {
    throw RangeError("/gitspace/oopish/oo-helpers.litcoffee oo.vArg()\n  signature " + signature + " is invalid");
  }
  signature = matches[0], key = matches[1], types = matches[2], rule = matches[3];
  pfx = M + ("argument " + key + " ");
  tv = oo.type(value);
  if (oo.U === tv) {
    if (4 === arguments.length) {
      return fallback;
    }
    throw TypeError(pfx + "is undefined and has no fallback");
  }
  ref = types.split('|');
  for (j = 0, len = ref.length; j < len; j++) {
    type = ref[j];
    if ((oo.N === type || oo.I === type) && oo.N === tv) {
      if (oo.I === type && value % 1) {
        throw RangeError(pfx + "is a number but not an integer");
      }
      if (rule) {
        ref1 = rule.split('-'), min = ref1[0], max = ref1[1];
        if (value < min || value > max) {
          throw RangeError(pfx + ("is " + value + " (must be " + rule + ")"));
        }
      }
      return value;
    }
    if (type === tv) {
      if (oo.S === tv && rule) {
        if (!RegExp(rule).test(value)) {
          throw RangeError(pfx + ("fails " + rule));
        }
      }
      return value;
    }
    if (/^[A-Z]/.test(type)) {
      if (oo.O === tv) {
        if (eval("value instanceof " + type)) {
          return value;
        }
      }
    }
  }
  throw TypeError(pfx + ("is type " + tv + " not " + types));
};

oo.vObject = function(M, objName, obj) {
  if (oo.O !== oo.type(obj)) {
    throw TypeError(M + objName + (" is type " + (oo.type(obj)) + " not object"));
  }
  return function(signature, fallback) {
    var j, key, len, matches, max, min, ref, ref1, rule, tv, type, types, value;
    matches = signature.match(/^([_a-z][_a-z0-9]*)\s+<([|a-z]+)\s*(.*)>$/i);
    if (!matches) {
      throw RangeError("/gitspace/oopish/oo-helpers.litcoffee oo.vObject()\n  signature " + signature + " is invalid");
    }
    signature = matches[0], key = matches[1], types = matches[2], rule = matches[3];
    value = obj[key];
    tv = oo.type(value);
    if (oo.U === tv) {
      if (2 === arguments.length) {
        return fallback;
      }
      throw TypeError(M + objName + '.' + key + " is undefined and has no fallback");
    }
    ref = types.split('|');
    for (j = 0, len = ref.length; j < len; j++) {
      type = ref[j];
      if ((oo.N === type || oo.I === type) && oo.N === tv) {
        if (oo.I === type && value % 1) {
          throw RangeError(M + objName + '.' + key + " is a number but not an integer");
        }
        if (rule) {
          ref1 = rule.split('-'), min = ref1[0], max = ref1[1];
          if (value < min || value > max) {
            throw RangeError(M + objName + '.' + key + (" is " + value + " (must be " + rule + ")"));
          }
        }
        return value;
      }
      if (type === tv) {
        if (oo.S === tv && rule) {
          if (!RegExp(rule).test(value)) {
            throw RangeError(M + objName + '.' + key + (" fails " + rule));
          }
        }
        return value;
      }
      if (/^[A-Z]/.test(type)) {
        if (oo.O === tv) {
          if (eval("value instanceof " + type)) {
            return value;
          }
        }
      }
    }
    throw TypeError(M + objName + '.' + key + (" is type " + tv + " not " + types));
  };
};

DB = (function() {
  DB.prototype.C = 'DB';

  DB.prototype.toString = function() {
    return '[object DB]';
  };

  function DB(config) {
    var M, v;
    if (config == null) {
      config = {};
    }
    M = '/gitspace/src/DB.litcoffee DB()\n  ';
    v = oo.vObject(M, 'config', config);
    this.x = v('x <number>', 123);
    oo.define(this, oo._, {}, 'private');
  }

  DB.prototype.xx = function(yy) {
    var M;
    M = '/gitspace/src/DB.litcoffee DB::xx()\n  ';
    return yy = oo.vArg(M, yy, 'yy <number>', 123);
  };

  return DB;

})();

DB.xx = function(yy) {
  var M;
  M = '/gitspace/src/DB.litcoffee DB.xx()\n  ';
  return yy = oo.vArg(M, yy, 'yy <number>', 123);
};

GitSpace = (function() {
  GitSpace.prototype.C = 'GitSpace';

  GitSpace.prototype.toString = function() {
    return '[object GitSpace]';
  };

  function GitSpace(config) {
    var M, v;
    if (config == null) {
      config = {};
    }
    M = '/gitspace/src/GitSpace.litcoffee GitSpace()\n  ';
    v = oo.vObject(M, 'config', config);
    this.env = v('env <string ^auto$|^dev$|^staging$|^live$|^browser$>', 'auto');
    this.ip = v('ip <string ^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$>');
    this.port = v('port <integer 1-9999>');
    this.dns = v('dns <string ^[-a-z0-9]{1,128}$>');
    this.http = v('http <object>');
    this.ws = v('ws <function>');
    this.page = v('page <string>', getDefaultPage());
    oo.define(this, oo._, {}, 'private');
    this[oo._]._servers = {
      http: null,
      ws: null
    };
    this[oo._]._db = new DB.Memory({
      initial: [
        {
          k: 'hi',
          v: 'there'
        }, {
          k: 'foo',
          v: 'bar'
        }
      ]
    });
    if ('GitSpace' === this.C) {
      oo.lock(this);
    }
  }

  GitSpace.prototype.start = function() {
    var M, httpServer, wsServer;
    M = '/gitspace/src/GitSpace.litcoffee GitSpace::start()\n  ';
    httpServer = this[oo._]._servers.http = this.http.createServer();
    wsServer = this[oo._]._servers.ws = new this.ws.Server({
      server: httpServer
    });
    wsServer.on('connection', (function(_this) {
      return function(ws) {
        ws.on('close', function() {
          return oo('Connection closed!');
        });
        ws.on('error', function(err) {
          return oo(err);
        });
        return ws.on('message', function(data, flags) {
          var err;
          if (flags.binary) {
            return;
          }
          if ('POST ' === data.substr(0, 5)) {
            oo('> ' + data.substr(5));
            err = _this[oo._]._db.update(data.substr(5));
            if (err) {
              ws.send("Error: " + err);
            }
            return _this.broadcast(_this[oo._]._db.list);
          } else if ('hi' === data) {
            return ws.send('hullo yourself');
          }
        });
      };
    })(this));
    httpServer.on('request', (function(_this) {
      return function(req, res) {
        return _this.onHttpRequest(req, res);
      };
    })(this));
    oo(oo.T + " " + oo.V + " is listening at IP " + this.ip + " on port " + this.port);
    return httpServer.listen(this.port, this.ip);
  };

  GitSpace.prototype.onHttpRequest = function(request, response) {
    var M, body;
    M = '/gitspace/src/GitSpace.litcoffee GitSpace::onHttpRequest()\n  ';
    if ('POST' === request.method) {
      body = '';
      request.on('data', function(chunk) {
        return body += chunk;
      });
      request.on('end', (function(_this) {
        return function() {
          var err;
          err = _this[oo._]._db.update(body);
          if (_this[oo._]._servers.ws.clients.length) {
            _this.broadcast(_this[oo._]._db.list);
          }
          return sendPage(response, _this.page, _this[oo._]._db, _this.dns, err);
        };
      })(this));
    } else if ('/favicon.ico' === request.url) {
      return sendFavicon(response);
    } else {
      sendPage(response, this.page, this[oo._]._db, this.dns);
    }
    return oo('HTTP Request for ' + request.url);
  };

  GitSpace.prototype.broadcast = function(data) {
    var M, client, err, error1, j, len, ref, results;
    M = '/gitspace/src/GitSpace.litcoffee GitSpace::broadcast()\n  ';
    if (oo.O === typeof data) {
      data = JSON.stringify(data);
    }
    ref = this[oo._]._servers.ws.clients;
    results = [];
    for (j = 0, len = ref.length; j < len; j++) {
      client = ref[j];
      try {
        results.push(client.send(data));
      } catch (error1) {
        err = error1;
        results.push(oo(M + 'broadcast error:', err));
      }
    }
    return results;
  };

  return GitSpace;

})();

GitSpace.xx = function(yy) {
  var M;
  M = '/gitspace/src/GitSpace.litcoffee GitSpace.xx()\n  ';
  return yy = oo.vArg(M, yy, 'yy <number>', 123);
};

sendFavicon = function(response) {
  var M;
  M = '/gitspace/src/GitSpace.litcoffee sendFavicon()\n  ';
  response.writeHead(200, {
    'Content-Type': 'image/x-icon'
  });
  return response.end();
};

sendPage = function(response, page, db, dns, error) {
  var M, el, list;
  M = '/gitspace/src/GitSpace.litcoffee sendPage()\n  ';
  list = (function() {
    var j, len, ref, results;
    ref = db.list;
    results = [];
    for (j = 0, len = ref.length; j < len; j++) {
      el = ref[j];
      results.push('    <dt>' + el.k + '</dt>\n    <dd>' + el.v + '</dd>');
    }
    return results;
  })();
  page = page.replace('%db%', list.join('\n'));
  page = page.replace('%error%', error || '');
  page = page.replace('%dns%', dns);
  response.writeHead(200, {
    'Content-Type': 'text/html'
  });
  return response.end(page);
};

getDefaultPage = function() {
  var M;
  M = '/gitspace/src/GitSpace.litcoffee getDefaultPage()\n  ';
  return "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>GitSpace</title>\n  <link rel=\"icon\" type=\"image/x-icon\" href=\"favicon.ico\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n</head>\n<body>\n  <h1>GitSpace</h1>\n  <pre id=\"error\">%error%</pre>\n  <form method=\"post\" action=\"\">\n    <input id=\"k\" name=\"k\" placeholder=\"key\">\n    <input id=\"v\" name=\"v\" placeholder=\"value\">\n    <br>\n    <input type=\"submit\" value=\"Update via POST\">\n  </form>\n  <div id=\"msg\">Loading...</div>\n  <dl id=\"db\">\n  %db%\n  </dl>\n  <script>\n    var $error = document.getElementById('error')\n      , $msg   = document.getElementById('msg')\n      , $k     = document.getElementById('k')\n      , $v     = document.getElementById('v')\n      , $db    = document.getElementById('db')\n      , $btn   = null //@todo make `null` after server disconnects itself\n      , ws     = new WebSocket('ws://%dns%:8000')\n    ;\n    $msg.innerHTML = 'WebSocket connecting...';\n    ws.onopen = function (event) {\n        $msg.innerHTML = '<button id=\"btn\">Update via WebSocket</button>';\n        $btn = document.getElementById('btn');\n        $btn.addEventListener('click', function () {\n            ws.send(\n                'POST'\n              + ' k=' + $k.value\n              + '&v=' + $v.value\n            );\n        });\n    }\n    ws.onmessage = function (evt) {\n        try {\n            var db = JSON.parse(evt.data);\n        } catch (err) { return error.innerHTML = err; }\n        for (var html=[], i=0, l=db.length; i<l; i++) {\n            if (! db[i]) continue\n            html[i] = '    <dt>' + db[i].k + '</dt>\\n'\n                    + '    <dd>' + db[i].v + '</dd>';\n        }\n        $db.innerHTML = html.join('\\n');\n    }\n  </script>\n</body>\n</html>";
};

DB.FileSystem = (function(superClass) {
  extend(FileSystem, superClass);

  FileSystem.prototype.C = 'DB.FileSystem';

  FileSystem.prototype.toString = function() {
    return '[object DB.FileSystem]';
  };

  function FileSystem(config) {
    var M, v;
    if (config == null) {
      config = {};
    }
    M = '/gitspace/src/DB/FileSystem.litcoffee DB.FileSystem()\n  ';
    FileSystem.__super__.constructor.call(this, config);
    v = oo.vObject(M, 'config', config);
    this.x = v('x <number>', 123);
    this[oo._]._x = null;
    if ('DB.FileSystem' === this.C) {
      oo.lock(this);
    }
  }

  FileSystem.prototype.xx = function(yy) {
    var M;
    M = '/gitspace/src/DB/FileSystem.litcoffee DB.FileSystem::xx()\n  ';
    return yy = oo.vArg(M, yy, 'yy <number>', 123);
  };

  return FileSystem;

})(DB);

DB.FileSystem.xx = function(yy) {
  var M;
  M = '/gitspace/src/DB/FileSystem.litcoffee DB.FileSystem.xx()\n  ';
  return yy = oo.vArg(M, yy, 'yy <number>', 123);
};

DB.Memory = (function(superClass) {
  extend(Memory, superClass);

  Memory.prototype.C = 'DB.Memory';

  Memory.prototype.toString = function() {
    return '[object DB.Memory]';
  };

  function Memory(config) {
    var M, el, i, j, len, ref, v;
    if (config == null) {
      config = {};
    }
    M = '/gitspace/src/DB/Memory.litcoffee DB.Memory()\n  ';
    Memory.__super__.constructor.call(this, config);
    v = oo.vObject(M, 'config', config);
    this.list = v('initial <array of object>', []);
    this.lut = {};
    ref = this.list;
    for (i = j = 0, len = ref.length; j < len; i = ++j) {
      el = ref[i];
      this.lut[el.k] = i;
    }
    oo.define(this, oo._, {}, 'private');
  }

  Memory.prototype.update = function(body) {
    var M, i, k, match, v;
    M = '/gitspace/src/DB/Memory.litcoffee DB.Memory::update()\n  ';
    match = body.match(/^k=([a-z]+)&v=([a-z]*)$/);
    if (!match) {
      return "Lowercase a-z keys and values only, for now";
    }
    k = match[1];
    v = match[2];
    i = this.lut[k];
    if (oo.isU(i)) {
      if ('' === v) {
        return "Value of new key '" + k + "' must not be blank";
      }
      oo(1, i, k, v);
      i = this.list.length;
      this.lut[k] = i;
      this.list[i] = {
        k: k,
        v: v
      };
    } else if ('' === v) {
      oo(2, i, k, v);
      this.list[i] = null;
      delete this.lut[k];
    } else {
      oo(3, i, k, v);
      this.list[i] = {
        k: k,
        v: v
      };
    }
    return '';
  };

  return Memory;

})(DB);

DB.Memory.xx = function(yy) {
  var M;
  M = '/gitspace/src/DB/Memory.litcoffee DB.Memory.xx()\n  ';
  return yy = oo.vArg(M, yy, 'yy <number>', 123);
};

oo.lock(GitSpace);

oo.lock(DB);

oo.lock(DB.FileSystem);

oo.lock(DB.Memory);

if (oo.F === typeof define && define.amd) {
  define(function() {
    return GitSpace;
  });
} else if (oo.O === typeof module && module && module.exports) {
  module.exports = GitSpace;
} else {
  oo.G.GitSpace = GitSpace;
}
}).call(this,this);
// Example vendor file. 
